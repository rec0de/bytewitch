package ParserTests

import bitmage.fromHex
import decoders.Nemesys.NemesysField
import decoders.Nemesys.NemesysSegment
import kotlin.test.Test

class TestNetzob {
    @Test
    fun testNetzobMessageGroups() {
        netzobMessageGroups.forEach { group ->
            println("=== Testing Netzob Group ${group.typeId} ===")
            group.messages.forEach { expected ->
                val actual = actualNetzobSegmentation.firstOrNull { it.index == expected.index }
                    ?: error("Actual segmentation for message ${expected.index} not found.")

                EvaluationHelper.printSegmentParsingResult(
                    testNumber = expected.index,
                    expectedSegments = expected.segments,
                    actualSegments = actual.segments
                )
            }
        }

        EvaluationHelper.printFinalScore()
    }


    val actualNetzobSegmentation = listOf(
        TestMessage(2,
            "a5626964187b68757365726e616d6565616c69636565656d61696c71616c696365406578616d706c652e636f6d6770726f66696c65a263616765181e67636f756e747279674765726d616e796969735f616374697665f5".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(1, NemesysField.UNKNOWN),
                NemesysSegment(4, NemesysField.UNKNOWN),
                NemesysSegment(6, NemesysField.UNKNOWN),
                NemesysSegment(15, NemesysField.UNKNOWN),
                NemesysSegment(21, NemesysField.UNKNOWN),
                NemesysSegment(22, NemesysField.UNKNOWN),
                NemesysSegment(23, NemesysField.UNKNOWN),
                NemesysSegment(27, NemesysField.UNKNOWN),
                NemesysSegment(33, NemesysField.UNKNOWN),
                NemesysSegment(34, NemesysField.UNKNOWN),
                NemesysSegment(41, NemesysField.UNKNOWN),
                NemesysSegment(42, NemesysField.UNKNOWN),
                NemesysSegment(45, NemesysField.UNKNOWN),
                NemesysSegment(53, NemesysField.UNKNOWN),
                NemesysSegment(54, NemesysField.UNKNOWN),
                NemesysSegment(58, NemesysField.UNKNOWN),
                NemesysSegment(60, NemesysField.UNKNOWN),
                NemesysSegment(68, NemesysField.UNKNOWN),
                NemesysSegment(76, NemesysField.UNKNOWN),
                NemesysSegment(77, NemesysField.UNKNOWN),
                NemesysSegment(78, NemesysField.UNKNOWN),
                NemesysSegment(86, NemesysField.UNKNOWN),
            )
        ),
        TestMessage(3,
            "a56269640368757365726e616d6563626f6265656d61696c6a626f6240676d782e64656770726f66696c65a263616765184c67636f756e747279635553416969735f616374697665f4".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(1, NemesysField.UNKNOWN),
                NemesysSegment(4, NemesysField.UNKNOWN),
                NemesysSegment(5, NemesysField.UNKNOWN),
                NemesysSegment(14, NemesysField.UNKNOWN),
                NemesysSegment(18, NemesysField.UNKNOWN),
                NemesysSegment(19, NemesysField.UNKNOWN),
                NemesysSegment(20, NemesysField.UNKNOWN),
                NemesysSegment(24, NemesysField.UNKNOWN),
                NemesysSegment(28, NemesysField.UNKNOWN),
                NemesysSegment(29, NemesysField.UNKNOWN),
                NemesysSegment(32, NemesysField.UNKNOWN),
                NemesysSegment(33, NemesysField.UNKNOWN),
                NemesysSegment(35, NemesysField.UNKNOWN),
                NemesysSegment(43, NemesysField.UNKNOWN),
                NemesysSegment(44, NemesysField.UNKNOWN),
                NemesysSegment(48, NemesysField.UNKNOWN),
                NemesysSegment(50, NemesysField.UNKNOWN),
                NemesysSegment(58, NemesysField.UNKNOWN),
                NemesysSegment(62, NemesysField.UNKNOWN),
                NemesysSegment(63, NemesysField.UNKNOWN),
                NemesysSegment(64, NemesysField.UNKNOWN),
                NemesysSegment(72, NemesysField.UNKNOWN),
            )
        ),
        TestMessage(13,
            "b90005626964181a68757365726e616d65656672616e7a65656d61696c746672616e7a2e6261756d616e6e40676d782e64656770726f66696c65b9000263616765183667636f756e7472796a4e65746865726c616e646969735f616374697665f4".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(3, NemesysField.UNKNOWN),
                NemesysSegment(6, NemesysField.UNKNOWN),
                NemesysSegment(8, NemesysField.UNKNOWN),
                NemesysSegment(17, NemesysField.UNKNOWN),
                NemesysSegment(23, NemesysField.UNKNOWN),
                NemesysSegment(24, NemesysField.UNKNOWN),
                NemesysSegment(25, NemesysField.UNKNOWN),
                NemesysSegment(29, NemesysField.UNKNOWN),
                NemesysSegment(43, NemesysField.UNKNOWN),
                NemesysSegment(44, NemesysField.UNKNOWN),
                NemesysSegment(47, NemesysField.UNKNOWN),
                NemesysSegment(48, NemesysField.UNKNOWN),
                NemesysSegment(50, NemesysField.UNKNOWN),
                NemesysSegment(58, NemesysField.UNKNOWN),
                NemesysSegment(61, NemesysField.UNKNOWN),
                NemesysSegment(65, NemesysField.UNKNOWN),
                NemesysSegment(67, NemesysField.UNKNOWN),
                NemesysSegment(75, NemesysField.UNKNOWN),
                NemesysSegment(86, NemesysField.UNKNOWN),
                NemesysSegment(87, NemesysField.UNKNOWN),
                NemesysSegment(88, NemesysField.UNKNOWN),
                NemesysSegment(96, NemesysField.UNKNOWN),
            )
        ),
        TestMessage(14,
            "b90005626964183568757365726e616d65666e696b65333265656d61696c6e6e696b6540676d61696c2e636f6d6770726f66696c65b90002636167651567636f756e7472796a4e65746865726c616e646969735f616374697665f5".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(3, NemesysField.UNKNOWN),
                NemesysSegment(6, NemesysField.UNKNOWN),
                NemesysSegment(8, NemesysField.UNKNOWN),
                NemesysSegment(17, NemesysField.UNKNOWN),
                NemesysSegment(24, NemesysField.UNKNOWN),
                NemesysSegment(25, NemesysField.UNKNOWN),
                NemesysSegment(26, NemesysField.UNKNOWN),
                NemesysSegment(30, NemesysField.UNKNOWN),
                NemesysSegment(35, NemesysField.UNKNOWN),
                NemesysSegment(36, NemesysField.UNKNOWN),
                NemesysSegment(41, NemesysField.UNKNOWN),
                NemesysSegment(42, NemesysField.UNKNOWN),
                NemesysSegment(45, NemesysField.UNKNOWN),
                NemesysSegment(53, NemesysField.UNKNOWN),
                NemesysSegment(56, NemesysField.UNKNOWN),
                NemesysSegment(60, NemesysField.UNKNOWN),
                NemesysSegment(61, NemesysField.UNKNOWN),
                NemesysSegment(69, NemesysField.UNKNOWN),
                NemesysSegment(80, NemesysField.UNKNOWN),
                NemesysSegment(81, NemesysField.UNKNOWN),
                NemesysSegment(82, NemesysField.UNKNOWN),
                NemesysSegment(90, NemesysField.UNKNOWN),
            )
        ),
        TestMessage(15,
            "b9000562696419035568757365726e616d656c73696d6f6e6c65686d616e6e65656d61696c736c65686d616e6e393840676d61696c2e636f6d6770726f66696c65b9000263616765181a67636f756e7472796742656c6769756d6969735f616374697665f5".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(3, NemesysField.UNKNOWN),
                NemesysSegment(6, NemesysField.UNKNOWN),
                NemesysSegment(9, NemesysField.UNKNOWN),
                NemesysSegment(18, NemesysField.UNKNOWN),
                NemesysSegment(31, NemesysField.UNKNOWN),
                NemesysSegment(32, NemesysField.UNKNOWN),
                NemesysSegment(33, NemesysField.UNKNOWN),
                NemesysSegment(37, NemesysField.UNKNOWN),
                NemesysSegment(47, NemesysField.UNKNOWN),
                NemesysSegment(48, NemesysField.UNKNOWN),
                NemesysSegment(53, NemesysField.UNKNOWN),
                NemesysSegment(54, NemesysField.UNKNOWN),
                NemesysSegment(57, NemesysField.UNKNOWN),
                NemesysSegment(65, NemesysField.UNKNOWN),
                NemesysSegment(68, NemesysField.UNKNOWN),
                NemesysSegment(72, NemesysField.UNKNOWN),
                NemesysSegment(74, NemesysField.UNKNOWN),
                NemesysSegment(82, NemesysField.UNKNOWN),
                NemesysSegment(90, NemesysField.UNKNOWN),
                NemesysSegment(91, NemesysField.UNKNOWN),
                NemesysSegment(92, NemesysField.UNKNOWN),
                NemesysSegment(100, NemesysField.UNKNOWN),
            )
        ),
        TestMessage(16,
            "b9000562696419017d68757365726e616d656d776f6c6667616e674b61666b6165656d61696c6e4b61666b613132407765622e64656770726f66696c65b9000263616765182e67636f756e74727965496e6469616969735f616374697665f5".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(3, NemesysField.UNKNOWN),
                NemesysSegment(6, NemesysField.UNKNOWN),
                NemesysSegment(9, NemesysField.UNKNOWN),
                NemesysSegment(18, NemesysField.UNKNOWN),
                NemesysSegment(32, NemesysField.UNKNOWN),
                NemesysSegment(33, NemesysField.UNKNOWN),
                NemesysSegment(34, NemesysField.UNKNOWN),
                NemesysSegment(38, NemesysField.UNKNOWN),
                NemesysSegment(46, NemesysField.UNKNOWN),
                NemesysSegment(47, NemesysField.UNKNOWN),
                NemesysSegment(50, NemesysField.UNKNOWN),
                NemesysSegment(51, NemesysField.UNKNOWN),
                NemesysSegment(53, NemesysField.UNKNOWN),
                NemesysSegment(61, NemesysField.UNKNOWN),
                NemesysSegment(64, NemesysField.UNKNOWN),
                NemesysSegment(68, NemesysField.UNKNOWN),
                NemesysSegment(70, NemesysField.UNKNOWN),
                NemesysSegment(78, NemesysField.UNKNOWN),
                NemesysSegment(84, NemesysField.UNKNOWN),
                NemesysSegment(85, NemesysField.UNKNOWN),
                NemesysSegment(86, NemesysField.UNKNOWN),
                NemesysSegment(94, NemesysField.UNKNOWN),
            )
        ),
        TestMessage(17,
            "b900056269640268757365726e616d656872616c664f74746f65656d61696c6f4f74746f3231407961686f6f2e64656770726f66696c65b90002636167651567636f756e7472796553797269616969735f616374697665f4".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(3, NemesysField.UNKNOWN),
                NemesysSegment(6, NemesysField.UNKNOWN),
                NemesysSegment(7, NemesysField.UNKNOWN),
                NemesysSegment(16, NemesysField.UNKNOWN),
                NemesysSegment(25, NemesysField.UNKNOWN),
                NemesysSegment(26, NemesysField.UNKNOWN),
                NemesysSegment(27, NemesysField.UNKNOWN),
                NemesysSegment(31, NemesysField.UNKNOWN),
                NemesysSegment(38, NemesysField.UNKNOWN),
                NemesysSegment(39, NemesysField.UNKNOWN),
                NemesysSegment(44, NemesysField.UNKNOWN),
                NemesysSegment(45, NemesysField.UNKNOWN),
                NemesysSegment(47, NemesysField.UNKNOWN),
                NemesysSegment(55, NemesysField.UNKNOWN),
                NemesysSegment(58, NemesysField.UNKNOWN),
                NemesysSegment(62, NemesysField.UNKNOWN),
                NemesysSegment(63, NemesysField.UNKNOWN),
                NemesysSegment(71, NemesysField.UNKNOWN),
                NemesysSegment(77, NemesysField.UNKNOWN),
                NemesysSegment(78, NemesysField.UNKNOWN),
                NemesysSegment(79, NemesysField.UNKNOWN),
                NemesysSegment(87, NemesysField.UNKNOWN),
            )
        ),
        TestMessage(18,
            "62706c6973743030d4010203040506070851635165526c53527047100e5a70726f64756374696f6e11eff65f102438464532413931422d393341332d314333332d464544332d45413435393344373942454108111315181b1d282b0000000000000101000000000000000900000000000000000000000000000052".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(28, NemesysField.UNKNOWN),
                NemesysSegment(29, NemesysField.UNKNOWN),
                NemesysSegment(41, NemesysField.UNKNOWN),
                NemesysSegment(43, NemesysField.UNKNOWN),
                NemesysSegment(46, NemesysField.UNKNOWN),
                NemesysSegment(59, NemesysField.UNKNOWN),
                NemesysSegment(60, NemesysField.UNKNOWN),
                NemesysSegment(64, NemesysField.UNKNOWN),
                NemesysSegment(65, NemesysField.UNKNOWN),
                NemesysSegment(69, NemesysField.UNKNOWN),
                NemesysSegment(70, NemesysField.UNKNOWN),
                NemesysSegment(82, NemesysField.UNKNOWN),
            )
        ),
        TestMessage(19,
            "62706c6973743030d4010203040506070851635165526c53527047101c5a70726f64756374696f6e11b6925f102441334245333743412d464133322d383436332d414633432d45333337434145453339463308111315181b1d282b0000000000000101000000000000000900000000000000000000000000000052".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(28, NemesysField.UNKNOWN),
                NemesysSegment(29, NemesysField.UNKNOWN),
                NemesysSegment(41, NemesysField.UNKNOWN),
                NemesysSegment(43, NemesysField.UNKNOWN),
                NemesysSegment(46, NemesysField.UNKNOWN),
                NemesysSegment(59, NemesysField.UNKNOWN),
                NemesysSegment(60, NemesysField.UNKNOWN),
                NemesysSegment(64, NemesysField.UNKNOWN),
                NemesysSegment(65, NemesysField.UNKNOWN),
                NemesysSegment(69, NemesysField.UNKNOWN),
                NemesysSegment(70, NemesysField.UNKNOWN),
                NemesysSegment(82, NemesysField.UNKNOWN),
            )
        ),
        TestMessage(20,
            "62706c6973743030d4010203040506070851635165526c53527047101c5a70726f64756374696f6e11b6925f102441334333394634432d463734332d414344332d383337322d42324136413346373833444508111315181b1d282b0000000000000101000000000000000900000000000000000000000000000052".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(28, NemesysField.UNKNOWN),
                NemesysSegment(29, NemesysField.UNKNOWN),
                NemesysSegment(41, NemesysField.UNKNOWN),
                NemesysSegment(43, NemesysField.UNKNOWN),
                NemesysSegment(46, NemesysField.UNKNOWN),
                NemesysSegment(59, NemesysField.UNKNOWN),
                NemesysSegment(60, NemesysField.UNKNOWN),
                NemesysSegment(64, NemesysField.UNKNOWN),
                NemesysSegment(65, NemesysField.UNKNOWN),
                NemesysSegment(69, NemesysField.UNKNOWN),
                NemesysSegment(70, NemesysField.UNKNOWN),
                NemesysSegment(82, NemesysField.UNKNOWN),
            )
        ),
        TestMessage(21,
            "62706c6973743030d4010203040506070851635165526c5352704710635a70726f64756374696f6e11d4315f102441424344454631322d333435362d373839302d414243442d45463132333435363738393008111315181b1d282b0000000000000101000000000000000900000000000000000000000000000052".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(28, NemesysField.UNKNOWN),
                NemesysSegment(29, NemesysField.UNKNOWN),
                NemesysSegment(41, NemesysField.UNKNOWN),
                NemesysSegment(43, NemesysField.UNKNOWN),
                NemesysSegment(46, NemesysField.UNKNOWN),
                NemesysSegment(59, NemesysField.UNKNOWN),
                NemesysSegment(60, NemesysField.UNKNOWN),
                NemesysSegment(64, NemesysField.UNKNOWN),
                NemesysSegment(65, NemesysField.UNKNOWN),
                NemesysSegment(69, NemesysField.UNKNOWN),
                NemesysSegment(70, NemesysField.UNKNOWN),
                NemesysSegment(82, NemesysField.UNKNOWN),
            )
        ),
        TestMessage(22,
            "62706c6973743030d4010203040506070851635165526c5352704710255a70726f64756374696f6e11a8ca5f102442414444434146452d313131312d323232322d333333332d34343434353535353636363608111315181b1d282b0000000000000101000000000000000900000000000000000000000000000052".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(28, NemesysField.UNKNOWN),
                NemesysSegment(29, NemesysField.UNKNOWN),
                NemesysSegment(41, NemesysField.UNKNOWN),
                NemesysSegment(43, NemesysField.UNKNOWN),
                NemesysSegment(46, NemesysField.UNKNOWN),
                NemesysSegment(59, NemesysField.UNKNOWN),
                NemesysSegment(60, NemesysField.UNKNOWN),
                NemesysSegment(64, NemesysField.UNKNOWN),
                NemesysSegment(65, NemesysField.UNKNOWN),
                NemesysSegment(69, NemesysField.UNKNOWN),
                NemesysSegment(70, NemesysField.UNKNOWN),
                NemesysSegment(82, NemesysField.UNKNOWN),
            )
        ),
        TestMessage(23,
            "62706c6973743030d4010203040506070851635165526c5352704710125a70726f64756374696f6e119a9e5f102443414645424142452d343332312d444342412d383736352d35363738353637383536373808111315181b1d282b0000000000000101000000000000000900000000000000000000000000000052".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(28, NemesysField.UNKNOWN),
                NemesysSegment(29, NemesysField.UNKNOWN),
                NemesysSegment(41, NemesysField.UNKNOWN),
                NemesysSegment(43, NemesysField.UNKNOWN),
                NemesysSegment(46, NemesysField.UNKNOWN),
                NemesysSegment(59, NemesysField.UNKNOWN),
                NemesysSegment(60, NemesysField.UNKNOWN),
                NemesysSegment(64, NemesysField.UNKNOWN),
                NemesysSegment(65, NemesysField.UNKNOWN),
                NemesysSegment(69, NemesysField.UNKNOWN),
                NemesysSegment(70, NemesysField.UNKNOWN),
                NemesysSegment(82, NemesysField.UNKNOWN),
            )
        ),
        TestMessage(24,
            "62706c6973743030d4010203040506070851635165526c5352704710415a70726f64756374696f6e1180005f102430313233343536372d383941422d434445462d303132332d34353637383941424344454608111315181b1d282b0000000000000101000000000000000900000000000000000000000000000052".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(28, NemesysField.UNKNOWN),
                NemesysSegment(29, NemesysField.UNKNOWN),
                NemesysSegment(41, NemesysField.UNKNOWN),
                NemesysSegment(43, NemesysField.UNKNOWN),
                NemesysSegment(46, NemesysField.UNKNOWN),
                NemesysSegment(59, NemesysField.UNKNOWN),
                NemesysSegment(60, NemesysField.UNKNOWN),
                NemesysSegment(64, NemesysField.UNKNOWN),
                NemesysSegment(65, NemesysField.UNKNOWN),
                NemesysSegment(69, NemesysField.UNKNOWN),
                NemesysSegment(70, NemesysField.UNKNOWN),
                NemesysSegment(82, NemesysField.UNKNOWN),
            )
        ),
        TestMessage(25,
            "62706c6973743030d4010203040506070851635165526c5352704710355a70726f64756374696f6e1130395f102446314532443343342d423541362d373839302d434445462d31333537394244463234363808111315181b1d282b0000000000000101000000000000000900000000000000000000000000000052".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(28, NemesysField.UNKNOWN),
                NemesysSegment(29, NemesysField.UNKNOWN),
                NemesysSegment(41, NemesysField.UNKNOWN),
                NemesysSegment(43, NemesysField.UNKNOWN),
                NemesysSegment(46, NemesysField.UNKNOWN),
                NemesysSegment(59, NemesysField.UNKNOWN),
                NemesysSegment(60, NemesysField.UNKNOWN),
                NemesysSegment(64, NemesysField.UNKNOWN),
                NemesysSegment(65, NemesysField.UNKNOWN),
                NemesysSegment(69, NemesysField.UNKNOWN),
                NemesysSegment(70, NemesysField.UNKNOWN),
                NemesysSegment(82, NemesysField.UNKNOWN),
            )
        ),
        TestMessage(26,
            "62706c6973743030d4010203040506070851635165526c5352704710205a70726f64756374696f6e11eadb5f102431323334414243442d353637382d454639302d414243442d30303131323233333434353508111315181b1d282b0000000000000101000000000000000900000000000000000000000000000052".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(28, NemesysField.UNKNOWN),
                NemesysSegment(29, NemesysField.UNKNOWN),
                NemesysSegment(41, NemesysField.UNKNOWN),
                NemesysSegment(43, NemesysField.UNKNOWN),
                NemesysSegment(46, NemesysField.UNKNOWN),
                NemesysSegment(59, NemesysField.UNKNOWN),
                NemesysSegment(60, NemesysField.UNKNOWN),
                NemesysSegment(64, NemesysField.UNKNOWN),
                NemesysSegment(65, NemesysField.UNKNOWN),
                NemesysSegment(69, NemesysField.UNKNOWN),
                NemesysSegment(70, NemesysField.UNKNOWN),
                NemesysSegment(82, NemesysField.UNKNOWN),
            )
        ),
        TestMessage(27,
            "62706c6973743030d4010203040506070851635165526c5352704710245a70726f64756374696f6e11b26e5f102442454546424545462d313031302d323032302d333033302d34303430353035303630373008111315181b1d282b0000000000000101000000000000000900000000000000000000000000000052".fromHex(),
            listOf(
                NemesysSegment(0, NemesysField.UNKNOWN),
                NemesysSegment(28, NemesysField.UNKNOWN),
                NemesysSegment(29, NemesysField.UNKNOWN),
                NemesysSegment(41, NemesysField.UNKNOWN),
                NemesysSegment(43, NemesysField.UNKNOWN),
                NemesysSegment(46, NemesysField.UNKNOWN),
                NemesysSegment(59, NemesysField.UNKNOWN),
                NemesysSegment(60, NemesysField.UNKNOWN),
                NemesysSegment(64, NemesysField.UNKNOWN),
                NemesysSegment(65, NemesysField.UNKNOWN),
                NemesysSegment(69, NemesysField.UNKNOWN),
                NemesysSegment(70, NemesysField.UNKNOWN),
                NemesysSegment(82, NemesysField.UNKNOWN),
            )
        ),
    )

    // group of messages with a similar structure
    val netzobMessageGroups = listOf(
        MessageGroup(0, TrainingMessageSamples.testMessages.withIndex().filter { it.index in listOf(2, 3, 13, 14, 15, 16, 17) }.map { it.value }),
        MessageGroup(1, TrainingMessageSamples.testMessages.withIndex().filter { it.index in listOf(18, 19, 20, 21, 22, 23, 24, 25, 26, 27) }.map { it.value })
    )
}